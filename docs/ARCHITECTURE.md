# ÏãúÏä§ÌÖú ÏïÑÌÇ§ÌÖçÏ≤ò & ÏÑ§Í≥Ñ

## üèóÔ∏è ÏãúÏä§ÌÖú ÏïÑÌÇ§ÌÖçÏ≤ò

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Client                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Spring Security                          ‚îÇ
‚îÇ                  (JWT Filter Chain)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Controllers                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇAuthController‚îÇ  ‚îÇOrderController‚îÇ  ‚îÇRefundControl ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ /auth/login  ‚îÇ  ‚îÇ   /orders    ‚îÇ  ‚îÇ   /refunds   ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ    SettlementSearchController                     ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ    /api/settlements/search (Elasticsearch)        ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Service Layer                            ‚îÇ
‚îÇ  RefundService + SettlementAdjustmentService                ‚îÇ
‚îÇ  SettlementBatchService (Ïùº Îã®ÏúÑ Î∞∞Ïπò)                      ‚îÇ
‚îÇ  SettlementIndexService (Elasticsearch ÏÉâÏù∏)                ‚îÇ
‚îÇ  SettlementSearchService (Î≥µÌï© Í≤ÄÏÉâ)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Repository Layer                               ‚îÇ
‚îÇ  Refund | SettlementAdjustment | Payment | Settlement       ‚îÇ
‚îÇ  SettlementSearchRepository (Elasticsearch)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                                       ‚îÇ
          ‚ñº                                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PostgreSQL Database  ‚îÇ            ‚îÇ   Elasticsearch      ‚îÇ
‚îÇ  refunds             ‚îÇ            ‚îÇ  settlement_search   ‚îÇ
‚îÇ  settlement_adj...   ‚îÇ            ‚îÇ  (Í≤ÄÏÉâ Ïù∏Îç±Ïä§)       ‚îÇ
‚îÇ  payments            ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  settlements         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìê ÎèÑÎ©îÏù∏ Î™®Îç∏ ÏÑ§Í≥Ñ

### Ï£ºÎ¨∏¬∑Í≤∞Ï†ú¬∑Ï†ïÏÇ∞ ÏÉÅÌÉú Ï†ÑÏù¥ Îã§Ïù¥Ïñ¥Í∑∏Îû®

#### Ï£ºÎ¨∏(Order) ÏÉÅÌÉú
- **CREATED**: Ï£ºÎ¨∏ ÏÉùÏÑ±Îê®(Í≤∞Ï†ú Ï†Ñ)
- **PAID**: Í≤∞Ï†ú ÏôÑÎ£åÎ°ú Ï£ºÎ¨∏ ÌôïÏ†ï
- **CANCELED**: Í≤∞Ï†ú Ï†Ñ Ï∑®ÏÜå
- **REFUNDED**: Í≤∞Ï†ú ÌõÑ ÌôòÎ∂à ÏôÑÎ£å

#### Í≤∞Ï†ú(Payment) ÏÉÅÌÉú
- **READY**: Í≤∞Ï†ú ÏÉùÏÑ±(ÏöîÏ≤≠ Ï§ÄÎπÑ)
- **AUTHORIZED**: ÏäπÏù∏Îê®(Ïπ¥Îìú/Í∞ÑÌé∏Í≤∞Ï†ú ÏäπÏù∏)
- **CAPTURED**: Îß§ÏûÖ/ÌôïÏ†ï(Ïã§ Í≤∞Ï†ú ÏôÑÎ£å)
- **FAILED**: Ïã§Ìå®
- **CANCELED**: ÏäπÏù∏ Ï∑®ÏÜå
- **REFUNDED**: Ï†ÑÏï° ÌôòÎ∂à ÏôÑÎ£å

#### ÌôòÎ∂à(Refund) ÏÉÅÌÉú - v0.2.0 Ïã†Í∑ú
- **REQUESTED**: ÌôòÎ∂à ÏöîÏ≤≠Îê®
- **APPROVED**: ÌôòÎ∂à ÏäπÏù∏Îê®
- **COMPLETED**: ÌôòÎ∂à ÏôÑÎ£å
- **FAILED**: ÌôòÎ∂à Ïã§Ìå®
- **CANCELED**: ÌôòÎ∂à Ï∑®ÏÜå

#### Ï†ïÏÇ∞(Settlement) ÏÉÅÌÉú
- **PENDING**: Ï†ïÏÇ∞ ÎåÄÏÉÅ ÏÉùÏÑ±(ÏïÑÏßÅ ÌôïÏ†ï Ï†Ñ)
- **CONFIRMED**: Ï†ïÏÇ∞ Í∏àÏï° ÌôïÏ†ï(ÌöåÍ≥Ñ Í∏∞Ï§Ä ÌôïÏ†ï)
- **CALCULATED**: Ï†ïÏÇ∞ Í≥ÑÏÇ∞ ÏôÑÎ£å
- **WAITING_APPROVAL**: ÏäπÏù∏ ÎåÄÍ∏∞
- **APPROVED**: ÏäπÏù∏ ÏôÑÎ£å
- **REJECTED**: ÏäπÏù∏ Í±∞Î∂Ä

#### Ï†ïÏÇ∞ Ï°∞Ï†ï(SettlementAdjustment) ÏÉÅÌÉú - v0.2.0 Ïã†Í∑ú
- **PENDING**: Ï°∞Ï†ï ÎåÄÍ∏∞ Ï§ë
- **CONFIRMED**: Ï°∞Ï†ï ÌôïÏ†ï

### ÌôòÎ∂à Ï≤òÎ¶¨ ÌùêÎ¶Ñ (v0.2.0)

```
[Payment] CAPTURED (amount: 10000, refundedAmount: 0)
   |
   | (Î∂ÄÎ∂ÑÌôòÎ∂à 3000Ïõê ÏöîÏ≤≠ + Idempotency-Key)
   v
[Refund] REQUESTED -> COMPLETED (amount: 3000)
   |
   v
[Payment] CAPTURED (amount: 10000, refundedAmount: 3000)
   |
   | (Î∂ÄÎ∂ÑÌôòÎ∂à 7000Ïõê ÏöîÏ≤≠)
   v
[Refund] REQUESTED -> COMPLETED (amount: 7000)
   |
   v
[Payment] REFUNDED (amount: 10000, refundedAmount: 10000)
```

### Ï†ïÏÇ∞ ÌôïÏ†ï ÌõÑ ÌôòÎ∂à Ïãú Ï°∞Ï†ï ÏÉùÏÑ±

```
[Settlement] CONFIRMED (amount: 10000)
   |
   | (ÌôòÎ∂à 2000Ïõê Î∞úÏÉù)
   v
[SettlementAdjustment] PENDING (amount: -2000, refund_id: ...)
   |
   | (ÏÉàÎ≤Ω 3Ïãú 10Î∂Ñ Î∞∞Ïπò)
   v
[SettlementAdjustment] CONFIRMED
```

## üóÑÔ∏è Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïä§ÌÇ§Îßà (v0.2.0)

### payments ÌÖåÏù¥Î∏î (Î≥ÄÍ≤Ω)
```sql
CREATE TABLE payments (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    refunded_amount DECIMAL(10, 2) NOT NULL DEFAULT 0,  -- Ïã†Í∑ú
    status VARCHAR(20) NOT NULL DEFAULT 'READY',
    payment_method VARCHAR(50),
    pg_transaction_id VARCHAR(100),
    captured_at TIMESTAMP,                              -- Ïã†Í∑ú
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT chk_payments_refunded_amount
        CHECK (refunded_amount >= 0 AND refunded_amount <= amount)
);
```

### refunds ÌÖåÏù¥Î∏î (Ïã†Í∑ú)
```sql
CREATE TABLE refunds (
    id BIGSERIAL PRIMARY KEY,
    payment_id BIGINT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'REQUESTED',
    reason TEXT,
    idempotency_key VARCHAR(255) NOT NULL,
    requested_at TIMESTAMP NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT fk_refund_payment FOREIGN KEY (payment_id) REFERENCES payments(id),
    CONSTRAINT chk_refunds_amount CHECK (amount > 0)
);

-- Î©±Îì±ÏÑ± Î≥¥Ïû•: ÎèôÏùº payment + idempotency_key Ï§ëÎ≥µ Î∞©ÏßÄ
CREATE UNIQUE INDEX idx_refunds_payment_idempotency
ON refunds(payment_id, idempotency_key);
```

### settlement_adjustments ÌÖåÏù¥Î∏î (Ïã†Í∑ú)
```sql
CREATE TABLE settlement_adjustments (
    id BIGSERIAL PRIMARY KEY,
    settlement_id BIGINT NOT NULL,
    refund_id BIGINT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    adjustment_date DATE NOT NULL,
    confirmed_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT fk_adjustment_settlement FOREIGN KEY (settlement_id) REFERENCES settlements(id),
    CONSTRAINT fk_adjustment_refund FOREIGN KEY (refund_id) REFERENCES refunds(id),
    CONSTRAINT chk_adjustments_amount CHECK (amount < 0)
);

-- ÌôòÎ∂à 1Í±¥Îãπ Ï°∞Ï†ï 1Í±¥ Î≥¥Ïû•
CREATE UNIQUE INDEX idx_adjustments_refund_id_unique
ON settlement_adjustments(refund_id);
```

### settlements ÌÖåÏù¥Î∏î
```sql
CREATE TABLE settlements (
    id BIGSERIAL PRIMARY KEY,
    payment_id BIGINT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    settlement_date DATE NOT NULL,
    confirmed_at TIMESTAMP,
    approver_id BIGINT,                                -- ÏäπÏù∏Ïûê ID
    approved_at TIMESTAMP,                             -- ÏäπÏù∏ ÏùºÏãú
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT fk_settlement_payment FOREIGN KEY (payment_id) REFERENCES payments(id)
);
```

## üîÑ v0.2.0 Î∂ÄÎ∂ÑÌôòÎ∂à Î¶¨Ìå©ÌÜ†ÎßÅ

### Ï£ºÏöî Î≥ÄÍ≤ΩÏÇ¨Ìï≠

**ÌôòÎ∂à Î™®Îç∏ Í∞úÏÑ†**:
- ‚ùå **Ïù¥Ï†Ñ**: Î∂ÄÎ∂ÑÌôòÎ∂à Ïãú ÏùåÏàò Payment Î†àÏΩîÎìú ÏÉùÏÑ± (ÎπÑÌëúÏ§Ä, Ï°∞Ìöå/ÌöåÍ≥Ñ Î≥µÏû°ÎèÑ Ï¶ùÍ∞Ä)
- ‚úÖ **ÌòÑÏû¨**: Refund ÏóîÌã∞Ìã∞Î°ú ÌôòÎ∂à Ïù¥Î†• Î∂ÑÎ¶¨ Í¥ÄÎ¶¨ (Ïã§Î¨¥ ÌëúÏ§Ä Ìå®ÌÑ¥)

**ÏÉàÎ°úÏö¥ Í∏∞Îä•**:
1. **Î©±Îì±ÏÑ± Î≥¥Ïû•**: `Idempotency-Key` Ìó§Îçî Í∏∞Î∞ò Ï§ëÎ≥µ ÌôòÎ∂à Î∞©ÏßÄ
2. **ÎèôÏãúÏÑ± Ï†úÏñ¥**: Payment row-level lock (PESSIMISTIC_WRITE)ÏúºÎ°ú ÌôòÎ∂à Í∏àÏï° Ï¥àÍ≥º Î∞©ÏßÄ
3. **Ï†ïÏÇ∞ Ï°∞Ï†ï**: CONFIRMED Ï†ïÏÇ∞ ÌõÑ ÌôòÎ∂à Ïãú `SettlementAdjustment` ÏÉùÏÑ± (ÌöåÍ≥Ñ Í∞êÏÇ¨ Ï∂îÏ†Å)
4. **ÌôòÎ∂à ÎàÑÏ†Å Ï∂îÏ†Å**: `Payment.refundedAmount`Î°ú Ïã§ÏãúÍ∞Ñ ÌôòÎ∂à ÎàÑÏ†Å Í¥ÄÎ¶¨

### ÎèÑÎ©îÏù∏ Î™®Îç∏ Î≥ÄÍ≤Ω

```
Payment (ÏõêÍ≤∞Ï†ú)
  - refundedAmount: ÌôòÎ∂à ÎàÑÏ†Å Ìï©Í≥Ñ (0 ~ amount)
  - status: REFUNDED (Ï†ÑÏï° ÌôòÎ∂à Ïãú)

Refund (ÌôòÎ∂à Ïù¥Î†•) - Ïã†Í∑ú Ï∂îÍ∞Ä
  - payment_id, amount, status, idempotency_key
  - (payment_id, idempotency_key) UNIQUE Ï†úÏïΩ

SettlementAdjustment (Ï†ïÏÇ∞ Ï°∞Ï†ï) - Ïã†Í∑ú Ï∂îÍ∞Ä
  - settlement_id, refund_id, amount(ÏùåÏàò)
  - CONFIRMED Ï†ïÏÇ∞Ïóê ÎåÄÌïú ÌôòÎ∂à Ï≤òÎ¶¨Ïö©
```

## üîê Î≥¥Ïïà ÏÑ§Í≥Ñ

### Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï†úÏïΩ Ï°∞Í±¥
- ‚úÖ `payments.refunded_amount` CHECK (0 ~ amount)
- ‚úÖ `refunds(payment_id, idempotency_key)` UNIQUE
- ‚úÖ `settlement_adjustments(refund_id)` UNIQUE
- ‚úÖ `refunds.amount` CHECK (> 0)
- ‚úÖ `settlement_adjustments.amount` CHECK (< 0)

### Î©±Îì±ÏÑ± Î≥¥Ïû•
- ‚úÖ ÎèôÏùº `Idempotency-Key` Ïû¨ÏöîÏ≤≠ Ïãú ÎèôÏùº Refund Î∞òÌôò
- ‚úÖ ÌôòÎ∂à Í∏àÏï° Ï§ëÎ≥µ Î∞òÏòÅ Î∞©ÏßÄ

### ÎèôÏãúÏÑ± Ï†úÏñ¥
- ‚úÖ `PESSIMISTIC_WRITE` lockÏúºÎ°ú ÎèôÏãú ÌôòÎ∂à ÏöîÏ≤≠ ÏßÅÎ†¨Ìôî
- ‚úÖ `refundedAmount` Ï¥àÍ≥º Î∞©ÏßÄ

### Î∞∞Ïπò Ïû¨Ïã§Ìñâ ÏïàÏ†ïÏÑ±
- ‚úÖ Settlement Ï§ëÎ≥µ ÏÉùÏÑ± Î∞©ÏßÄ (`findByPaymentId` Ï≤¥ÌÅ¨)
- ‚úÖ Adjustment Ï§ëÎ≥µ ÏÉùÏÑ± Î∞©ÏßÄ (`findByRefundId` Ï≤¥ÌÅ¨)

## üìä Î™®ÎãàÌÑ∞ÎßÅ & Í≤ÄÏÉâ ÏïÑÌÇ§ÌÖçÏ≤ò

### Prometheus & Grafana (ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ)
- **Prometheus**: `/actuator/prometheus` ÏóîÎìúÌè¨Ïù∏Ìä∏Î°ú Î©îÌä∏Î¶≠ ÏàòÏßë
- **Grafana**: Ïã§ÏãúÍ∞Ñ ÎåÄÏãúÎ≥¥Îìú Î∞è ÏïåÎ¶º ÏÑ§Ï†ï
- **Slack ÏïåÎ¶º**: ÏóêÎü¨Ïú®/ÏùëÎãµÏãúÍ∞Ñ ÏûÑÍ≥ÑÏπò Ï¥àÍ≥º Ïãú ÏûêÎèô ÏïåÎ¶º

### Elasticsearch (Ï†ïÏÇ∞ Í≤ÄÏÉâ)
- **settlement_search Ïù∏Îç±Ïä§**: Ï†ïÏÇ∞/Ï£ºÎ¨∏/Í≤∞Ï†ú/ÌôòÎ∂à ÌÜµÌï© Îç∞Ïù¥ÌÑ∞
- **Nori Analyzer**: ÌïúÍ∏Ä ÌòïÌÉúÏÜå Î∂ÑÏÑù (Í≤∞Ï†ú ÏàòÎã®, ÌôòÎ∂à ÏÇ¨Ïú† Îì±)
- **Î≥µÌï© Í≤ÄÏÉâ API**: Í∏∞Í∞Ñ/Í∏àÏï°/ÏÉÅÌÉúÎ≥Ñ ÌïÑÌÑ∞ÎßÅ + ÏßëÍ≥Ñ

## ‚öôÔ∏è Ï†ïÏÇ∞ Î∞∞Ïπò ÏûëÏóÖ

- **Îß§Ïùº ÏÉàÎ≤Ω 2Ïãú**: Ï†ÑÎÇ† `CAPTURED` Í≤∞Ï†ú ‚Üí `PENDING` Ï†ïÏÇ∞ ÏÉùÏÑ±
- **Îß§Ïùº ÏÉàÎ≤Ω 3Ïãú**: `PENDING` Ï†ïÏÇ∞ ‚Üí `CONFIRMED` ÌôïÏ†ï
- **Îß§Ïùº ÏÉàÎ≤Ω 3Ïãú 10Î∂Ñ**: `PENDING` Ï†ïÏÇ∞ Ï°∞Ï†ï ‚Üí `CONFIRMED` ÌôïÏ†ï (v0.2.0)
- **Ï†ïÏÇ∞ Îç∞Ïù¥ÌÑ∞ Elasticsearch ÏÉâÏù∏**: Ï†ïÏÇ∞ ÏÉùÏÑ±/ÏàòÏ†ï Ïãú ÏûêÎèô ÏÉâÏù∏ (Spring Event Í∏∞Î∞ò)

## üèõÔ∏è Ïù∏ÌîÑÎùº Íµ¨ÏÑ± Ï†ÑÎûµ

Ïù¥ ÌîÑÎ°úÏ†ùÌä∏Îäî **ÌïòÏù¥Î∏åÎ¶¨Îìú Ïù∏ÌîÑÎùº Íµ¨ÏÑ±**ÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§:

| Ïª¥Ìè¨ÎÑåÌä∏ | ÌôòÍ≤Ω | Ïù¥Ïú† |
|---------|------|------|
| **PostgreSQL** | Î°úÏª¨ ÏÑ§Ïπò | ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÍ≥º ÎèôÏùºÌïú ÏÑ§Ï†ï, ÏÑ±Îä• ÏµúÏ†ÅÌôî |
| **Elasticsearch** | Cloud (Elastic Cloud) | ÌôïÏû•ÏÑ±, Í¥ÄÎ¶¨ Ïö©Ïù¥ÏÑ±, ÌîÑÎ°úÎçïÏÖò ÎåÄÎπÑ |
| **Prometheus** | Docker | Í∞úÎ∞ú ÌôòÍ≤Ω Ï†ÑÏö© Î©îÌä∏Î¶≠ ÏàòÏßë |
| **Grafana** | Docker | Í∞úÎ∞ú ÌôòÍ≤Ω Ï†ÑÏö© ÏãúÍ∞ÅÌôî ÎåÄÏãúÎ≥¥Îìú |
